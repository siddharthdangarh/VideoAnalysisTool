{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="chat-container">
    <div class="chat-header">
        <h2>Video Analysis Tool</h2>
    </div>
    <div id="chat-messages" class="chat-messages">
        <!-- Messages will be dynamically inserted here -->
    </div>
    <form id="chat-form" class="chat-form" method="post" enctype="multipart/form-data">
        <div class="file-upload">
            <label for="video-file">Upload Video File (hardcoded for now):</label>
            <input type="file" id="video-file" name="video-file" disabled>
            <span class="hardcoded-note">(File is hardcoded in backend for now)</span>
        </div>
        <div class="query-input">
            <input type="text" id="user-query" name="query" placeholder="Ask something about your video..." autocomplete="off" required>
            <button type="submit">Send</button>
        </div>
    </form>
</div>

<style>
.chat-container {
    max-width: 600px;
    margin: 40px auto;
    background: #fff;
    border-radius: 16px;
    box-shadow: 0 4px 24px rgba(0,0,0,0.08);
    padding: 0 0 24px 0;
    font-family: 'Segoe UI', Arial, sans-serif;
}
.chat-header {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 24px 24px 0 24px;
}
.cat-avatar {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    background: #f3f3f3;
    border: 2px solid #eee;
}
.chat-header h2 {
    margin: 0;
    font-size: 1.5rem;
    color: #333;
}
.chat-messages {
    min-height: 240px;
    max-height: 320px;
    overflow-y: auto;
    padding: 24px;
    background: #fafbfc;
    border-radius: 12px;
    margin: 16px 24px;
    box-shadow: 0 1px 2px rgba(0,0,0,0.03);
}
.message {
    display: flex;
    align-items: flex-end;
    margin-bottom: 16px;
}
.message.user .bubble {
    background: #e0f7fa;
    color: #00796b;
    margin-left: auto;
}
.message.bot .bubble {
    background: #f3e5f5;
    color: #6a1b9a;
    margin-right: auto;
}
.bubble {
    padding: 12px 18px;
    border-radius: 18px;
    max-width: 70%;
    font-size: 1rem;
    box-shadow: 0 1px 4px rgba(0,0,0,0.04);
}
.chat-form {
    display: flex;
    flex-direction: column;
    gap: 12px;
    padding: 0 24px;
}
.file-upload {
    display: flex;
    align-items: center;
    gap: 12px;
    font-size: 0.95rem;
    color: #888;
}
.hardcoded-note {
    font-size: 0.85rem;
    color: #bdbdbd;
}
.query-input {
    display: flex;
    gap: 8px;
}
#user-query {
    flex: 1;
    padding: 10px 14px;
    border-radius: 8px;
    border: 1px solid #ddd;
    font-size: 1rem;
}
button[type="submit"] {
    background: #6a1b9a;
    color: #fff;
    border: none;
    border-radius: 8px;
    padding: 10px 20px;
    font-size: 1rem;
    cursor: pointer;
    transition: background 0.2s;
}
button[type="submit"]:hover {
    background: #4a148c;
}
</style>

<script>
const chatForm = document.getElementById('chat-form');
const chatMessages = document.getElementById('chat-messages');
const userQueryInput = document.getElementById('user-query');

function appendMessage(sender, text) {
    const msgDiv = document.createElement('div');
    msgDiv.className = `message ${sender}`;
    const bubble = document.createElement('div');
    bubble.className = 'bubble';
    bubble.textContent = text;
    msgDiv.appendChild(bubble);
    chatMessages.appendChild(msgDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

chatForm.addEventListener('submit', async function(e) {
    e.preventDefault();
    const query = userQueryInput.value.trim();
    if (!query) return;
    appendMessage('user', query);
    userQueryInput.value = '';
    appendMessage('bot', 'Thinking...');
    try {
        const response = await fetch('/search/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken'),
            },
            body: JSON.stringify({
                query: query,
                video_file_id: 'HARDCODED-VIDEO-FILE-ID' // Replace with actual ID
            })
        });
        const data = await response.json();
        chatMessages.removeChild(chatMessages.lastChild); // Remove 'Thinking...'
        if (data.error) {
            appendMessage('bot', 'Error: ' + data.error);
        } else {
            appendMessage('bot', data.video ? `Relevant video segment: ${data.video}` : 'No result found.');
        }
    } catch (err) {
        chatMessages.removeChild(chatMessages.lastChild);
        appendMessage('bot', 'Error: Could not reach server.');
    }
});

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock content %}